FIXING FOREIGN KEY CONSTRAINT VIOLATIONS
======================================

ERROR ANALYSIS
--------------

You're seeing this error:
```
"insert or update on table \"home_notes\" violates foreign key constraint \"home_notes_user_id_fkey\""
"Key is not present in table \"profiles\"."
```

This means:
1. You're trying to insert a record into the `home_notes` table
2. The `user_id` you're providing doesn't exist in the `profiles` table
3. Because of the foreign key constraint, PostgreSQL prevents the insert

ROOT CAUSE
----------

During user signup, a profile should be automatically created in the `profiles` table. However, this isn't happening correctly, leading to a mismatch between:
1. The user ID in the authentication system
2. The user ID in the `profiles` table

WHAT WAS FIXED
--------------

1. Enhanced profile creation logic in AuthContext:
   - Better error handling during profile creation
   - More robust handling of duplicate key errors
   - Clearer error messages when profile creation fails

2. Improved error messaging:
   - More descriptive error messages
   - Better logging for debugging

HOW TO VERIFY THE FIX
---------------------

1. Create a new user account:
   - Use a completely new email that has never been used before
   - Complete the signup process
   - Check if a profile is created in the `profiles` table

2. Check existing users:
   - For existing users who might be missing profiles, you may need to manually create profiles

DATABASE VERIFICATION STEPS
---------------------------

1. Check if profiles exist for your users:
   - In Supabase SQL editor, run:
     ```sql
     SELECT * FROM profiles;
     ```
   - Check if there's a profile for each user

2. Check the relationship:
   - Verify that user IDs in `profiles` match the IDs in the auth system
   - Run:
     ```sql
     SELECT id FROM auth.users;
     ```
   - Compare with:
     ```sql
     SELECT id FROM profiles;
     ```

MANUAL FIX FOR EXISTING USERS
-----------------------------

If you have existing users without profiles, you can manually create them:

```sql
INSERT INTO profiles (id, name)
SELECT id, 'Default Name'
FROM auth.users
WHERE id NOT IN (SELECT id FROM profiles);
```

Replace 'Default Name' with an appropriate default or prompt users to update their names.

PREVENTION
----------

1. Always ensure that when a user signs up:
   - Their profile is created in the `profiles` table
   - The profile uses the same ID as the auth user
   - The profile creation happens as part of the signup transaction

2. Handle errors properly:
   - Don't silently ignore profile creation errors
   - Provide clear feedback to users when something goes wrong

TESTING
-------

1. After redeploying:
   - Create a new user account
   - Log in with that account
   - Try to create a home note
   - Verify that it works without errors

2. Check the database:
   - Verify that a profile was created for the new user
   - Verify that the profile ID matches the auth user ID

If you continue to experience issues, please check:
1. The browser console for detailed error messages
2. The Supabase logs for database errors
3. The `profiles` table to ensure it contains entries for all users